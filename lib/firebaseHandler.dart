import 'dart:convert';
import 'dart:isolate';

import 'package:farm_to_dish/global_objects.dart';
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import 'package:http/http.dart' as http;

import 'Remote/modelstack.dart';
import 'Repository/databaseHelper.dart';
import 'firebase_options.dart';
import 'global_handlers.dart';
import 'global_string.dart';

import 'package:googleapis_auth/auth_io.dart' as auth;
import 'package:googleapis/servicecontrol/v1.dart' as servicecontrol;
//import 'package:googleapis/servicecontrol/v1.dart
//08033500977 Pastor Sam
import 'dart:convert';
import 'package:flutter/services.dart';
import 'dart:developer' as devtools show log;

//import 'notificationcontroller.dart';

// core Flutter primitives
import 'package:flutter/foundation.dart';
// core FlutterFire dependency
import 'package:firebase_core/firebase_core.dart';
// generated by

import 'firebase_options.dart';
// FlutterFire's Firebase Cloud Messaging plugin

import 'package:firebase_messaging/firebase_messaging.dart';

import 'sharedpref.dart';

Future<String> handleUpdates(
    RemoteMessage remoteMessage, bool foreground) async {
  String response = "";
  if (remoteMessage.notification != null) {
    try {
      String msg = jsonEncode(remoteMessage.notification!.body);
      logger("Body:$msg");

      String ttld = jsonEncode(remoteMessage.notification!.title);
      logger("Title:$ttld");

      /*

      Map<String, dynamic> json = jsonDecode(jsonDecode(msg));
      logger("The Title${json['title']}");

      if (json['notify']) {
        NotificationController.createNewNotification(
            json['title'], json['content']);
      }

      */

      Map<String, dynamic> dtt = remoteMessage.data;
      String parse = jsonEncode(dtt);
      logger("The Data: $parse");

      await firebaseProcession(parse);

      // _run(json['content'], json[unq], parse, dtt);
    } catch (e) {
      logger("handler error: $e");
    }
  }

  return response;
}

Future<void> firebaseProcession(String data) async {
  try {
    logger("My Data: $data");
    Map<String, dynamic> dtt = jsonDecode(data);
    logger("Data ess: ${dtt["essence"]}");
    pref = SharedPref();
    switch (dtt["essence"]) {
      case instr:
        break;
      case brdc:
        broadcast bdc =
            broadcast(caption: dtt[cpt], cta: dtt[cta], image: dtt[img]);

        Map<String, String> hd = {cpt: dtt[cpt], cta: dtt[cta], img: dtt[img]};
        pref.setPrefString(cpt, jsonEncode(hd));

        dshCtx.read<UINotifier>().broadCast(bdc);
        break;
      case acct:
        String bal = dtt[amt];
        try {
          /*
          DatabaseHelper dba = DatabaseHelper(table: usrWlt);

          //   [id, usrId, amt, lstTrnz];
          Map<String, dynamic> item = {
            id: "909891",
            usrId: "909891",
            amt: bal,
            lstTrnz: ""
          };

          

          dba.insertData(item);
          */

          pref.setPrefString(acct, bal);

          balance blh = balance(bal: bal);
          //bll = blh;
          dshCtx.read<UINotifier>().accountBalance(blh);
        } catch (e) {
          logger("$acct Error:  $e");
        }
        break;
    }
  } catch (e) {
    logger("fb procession error: $e");
  }
}

late SharedPref pref;

void _backgroundTask(SendPort sendPort) {
  // Perform time-consuming operation here
  // ...

  // Send result back to the main UI isolate
  sendPort.send('Task completed successfully!');
}

final ReceivePort _port = ReceivePort();

void _startBackgroundTask() async {
  try {
    await Isolate.spawn(_backgroundTask, _port.sendPort);
    _port.listen((message) async {
      logger("got a notification**");

      await Firebase.initializeApp(
        options: DefaultFirebaseOptions.currentPlatform,
      );
    });
  } catch (e) {
    logger("check error: $e");
  }

  try {
    final fcmToken = await FirebaseMessaging.instance.getToken();
    fbId = fcmToken!;
    logger("UserToken:$fbId");
    pref.setPrefString(tk_id, fcmToken);
    pref.setPrefBool(token, true);
  } catch (e) {}

  //  await FirebaseMessaging.instance.getToken();

  //  await Firebase.initializeApp();

  FirebaseMessaging.onMessage.listen((RemoteMessage message) {
    // ignore: avoid_print
    print('Got a message whilst in the foreground!');
    if (message.notification != null) {
      // print('Notification Title: ${message.notification.title}');
      // print('Notification Body: ${message.notification.body}');
    }
  });

  Future<void> messageHandler(RemoteMessage message) async {
    String msg = jsonEncode(message.data);
    logger("Background Message Received:$msg");
    logger("Msg rcpt");
  }

  FirebaseMessaging.onBackgroundMessage(messageHandler);

  FirebaseMessaging.onMessage.listen((event) {
    logger("Fore");
    // do something
  });
  FirebaseMessaging.onMessageOpenedApp.listen((event) {
    logger("Fore OPen");
    // do something
  });

  // FirebaseMessaging.onMessage.listen((RemoteMessage message) {
  //   /*
  //   setState(() {
  //     _messages = [..._messages, message];
  //   });

  //   */
  //   logger("CheckMsg***$message");
  // });
}

Future<void> subscribeToTopic(String topic) async {
  await Firebase.initializeApp();
  await FirebaseMessaging.instance.subscribeToTopic(topic);
}

Future<void> unsubscribeFromTopic(String topic) async {
  await FirebaseMessaging.instance.unsubscribeFromTopic(topic);
}

Future<void> obtainPermissions() async {
  FirebaseMessaging messaging = FirebaseMessaging.instance;

  NotificationSettings settings = await messaging.requestPermission(
    alert: true,
    announcement: false,
    badge: true,
    carPlay: false,
    criticalAlert: false,
    provisional: false,
    sound: true,
  );

  if (settings.authorizationStatus == AuthorizationStatus.authorized) {
    print('User granted permission');
  } else if (settings.authorizationStatus == AuthorizationStatus.provisional) {
    print('User granted provisional permission');
  } else {
    print('User declined or has not accepted permission');
  }
}

/*

Future<void> sendMessageToFcmTopic() throws Exception {
   String topicName = "app_promotion";

   Message message =
       Message.builder()
           .setNotification(
               Notification.builder()
                   .setTitle("A new app is available")
                   .setBody("Check out our latest app in the app store.")
                   .build())
           .setAndroidConfig(
               AndroidConfig.builder()
                   .setNotification(
                       AndroidNotification.builder()
                           .setTitle("A new Android app is available")
                           .setBody("Our latest app is available on Google Play store")
                           .build())
                   .build())
           .setTopic("app_promotion")
           .build();

   FirebaseMessaging.getInstance().send(message);

   System.out.println("Message to topic sent successfully!!");
 }

 */

Future<String> getAccessToken() async {
  final serviceAccountJson = {
    "type": "service_account",
    "project_id": "farmtodish-7e3e2",
    "private_key_id": "933c892cc41ccc5c12dc405e7edcd7899696dba1",
    "private_key":
        "-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQDLxhVsO9X/0rGJ\ncXipEAbh2kLVh/M3b9NX6g5zLO8gFfWyXh9PgiNWv5qfmeYsqthh5T+QXpOD41Yj\nQeNk8KIqguOYs7JsbLdct7Nwy2pu/XFIfT1t/+5ExvSjfqd29c5PRKumr+N88nMM\noAql4q8b6P1ijBiX0vB9+5QiGSwQarf3DLQOmJsSYsqx6lA6RCe89ycRmccwNWgQ\n3Uouzio0rq3fSP5AqDr2AAZH3Ap05WNwHz2S6kNOWqWJLaVqgEP208BwHCOenbSW\nAGKrtDVkGCb6RbJ15/+aLqT1FBkCRvi6Z49WLNrEXuEXXz+QanOBS5aaruxX7NCY\nWMka9cX3AgMBAAECggEADg7jDiMtUbI4yqv9ZbcpV7jga4LZkLWHoG+8AiN+ISSN\nXXozhsoKThh3PmjhAaviXxPwcrFTqVcBwPpGtIFgGWFg+k6gvJeI1D4ILyaZd9bG\n/ffwnlTNx15CemppJe0yB932SaWmIsnx41PB6E00miRUzCZbe/3y1tOIa2HOhxig\n2rEUoUidiqJFlgWZne/9IJcQt3z/RPBO6Za7/zpSkkngoNBIo3D5lVXcFdlO59QA\nQkQpONPNwELMacUYcNAjg95e+im5OSACuQ2pEGksModsdxk0XTIlYOe5ruax75La\n/d0+UrikupoaYICXoKinv62iQP13B5jX/Da09SGZQQKBgQDpnFDtL6CIgNmZdsPd\nDS3bP2S+HLBXn6YoHDP0hYycwNg9ErIhVVzsAKe/z3R4fK7WuhgaOTaVX25Vr8sA\nbaTlKxVAUYIlBfa12B7k+4XdX4u81jWiffLkC79Y6pP+gvAKtdUW3bnXZoJgSeta\nxILK6UxvrI0x5O+7nOWdP8V0LwKBgQDfTbboe5+8UkhUnv/RRIzgk65EzS40pTF+\nqMW0v3iPrsXkrlcQWJfzyCfNnvqDowrVbzDW+FUD130lilVO0QmhJ5bHzv3BvOUi\nndmFC3pBnOqwIcdkYspOy4W5Ic5+jKg+E4GzSERjlrLtEHllvq1t/dXSrm5HL22+\nGrP0TUQwuQKBgBY4slH9h820Q/6fF359dHE4lIKpA/Ux0IJcPGz0Dy4SAf+9OYiG\nMDKa1Vofh7q2UYNHbGeCLbkDvOEVub+urlLGSF0346NV7+PYTQgHDPLD1ez+i1eL\nl4EtxOPWXIGHPwIlzcFBEh51N82k+mhF7RMUIhs1VLD8T/mOsSDGIigtAoGBANu+\nMjxdSzebESqUvNFGUAu/yEJUVx/fX/FwS/4uXYmnR35eQbcIN5/iW6jwxT08+LBI\nFxu0jJSXPcPveTtyYbOArdQ6UWSRajrCcweF3+0paZmh5AFZZhRcG1+vcPD/oaBU\nudGfUA1ggvret1f0Z95RaFVG6aaLeccVp/jFAFGhAoGAJOu0d9R7JpR6AHAQoBEK\nAtL16VbT0cHxO2ifeJCgFKZ4m5T0BGpeHviXoSSyYg+yYWSCXUCBlMoEdoTLwt/k\ntjqHpwKCA+qwm/yOoVFAwGNdlIdAeGzQTRfrALjEjc78ldJk78rw3EmGyMDlW5L2\n5BNu4VBEi6nl8o9+FMnDnhs=\n-----END PRIVATE KEY-----\n",
    "client_email": "farmtodish@farmtodish-7e3e2.iam.gserviceaccount.com",
    "client_id": "117824464470213004977",
    "auth_uri": "https://accounts.google.com/o/oauth2/auth",
    "token_uri": "https://oauth2.googleapis.com/token",
    "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
    "client_x509_cert_url":
        "https://www.googleapis.com/robot/v1/metadata/x509/farmtodish%40farmtodish-7e3e2.iam.gserviceaccount.com",
    "universe_domain": "googleapis.com"
  };

  List<String> scopes = [
    "https://www.googleapis.com/auth/firebase.messaging",
    "https://www.googleapis.com/auth/firebase.database",
    "https://www.googleapis.com/auth/userInfo.email"
  ];

  http.Client client = await auth.clientViaServiceAccount(
      auth.ServiceAccountCredentials.fromJson(serviceAccountJson), scopes);

  auth.AccessCredentials credentials =
      await auth.obtainAccessCredentialsViaServiceAccount(
          auth.ServiceAccountCredentials.fromJson(serviceAccountJson),
          scopes,
          client);

  client.close();
  return credentials.accessToken.data;
}

Future<void> sendNotification(String deviceToken, BuildContext context,
    Map<String, dynamic> notification, Map<String, dynamic> data) async {
  final String accessToken = await getAccessToken();

  const String senderId = 'farmtodish-7e3e2';
  String fcmendpoint =
      'https://fcm.googleapis.com/v1/projects/$senderId/messages:send';

  Map<String, dynamic> payload = {
    "message": {
      "token":
          "df9QLll-R2iNATQXbNegPJ:APA91bGK9fe9BpiwRrxvUdu0h1sg5vu8bEvLuui08ozsI0BKwwb5SyfdDylW6Vw82qW0HJR6WkF6VEiVueRW6Qh1udaUucxdrK7oTSRwq8DJCTKbSir_TYI",
      "notification": {"body": "Checking", "title": "FCM Message"},
      "data": {
        "id": "story_1234567890***",
        "essence": "account",
        "amount": "42750.28k"

        /*
            "essence": "broadcast",
            "caption": "Get all your deliveries at your doorsteps without stress",
            "cta": "Start now",
            "image": ""
            */
      }
    }
  };
}

//Future<void> sendNotice() {}

Future<bool> sendPushMessage({
  required String recipientToken,
  required String title,
  required String body,
}) async {
  final jsonCredentials = await rootBundle.loadString('data/auth.json');
  final creds = auth.ServiceAccountCredentials.fromJson(jsonCredentials);

  final client = await auth.clientViaServiceAccount(
    creds,
    ['https://www.googleapis.com/auth/cloud-platform'],
  );

  final notificationData = {
    'message': {
      'token': recipientToken,
      'notification': {'title': title, 'body': body}
    },
  };

  //https://fcm.googleapis.com/v1/projects/farmtodish-7e3e2/messages:send

  const String senderId = 'farmtodish-7e3e2';
  final response = await client.post(
    Uri.parse('https://fcm.googleapis.com/v1/projects/$senderId/messages:send'),
    headers: {
      'content-type': 'application/json',
    },
    body: jsonEncode(notificationData),
  );

  client.close();
  if (response.statusCode == 200) {
    return true; // Success!
  }

  devtools.log(
      'Notification Sending Error Response status: ${response.statusCode}');
  devtools.log('Notification Response body: ${response.body}');
  return false;
}

/*

Future<void> sendMessageToFcmTopic() throws Exception {
   String topicName = "app_promotion";

   Message message =
       Message.builder()
           .setNotification(
               Notification.builder()
                   .setTitle("A new app is available")
                   .setBody("Check out our latest app in the app store.")
                   .build())
           .setAndroidConfig(
               AndroidConfig.builder()
                   .setNotification(
                       AndroidNotification.builder()
                           .setTitle("A new Android app is available")
                           .setBody("Our latest app is available on Google Play store")
                           .build())
                   .build())
           .setTopic("app_promotion")
           .build();

   FirebaseMessaging.instance.send(message);

   System.out.println("Message to topic sent successfully!!");
 }

 */
